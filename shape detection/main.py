'''

Packages:
# Name                    Version                   Build  Channel
anaconda-client           1.9.0            py39haa95532_0
anaconda-navigator        2.1.4            py39haa95532_0
asn1crypto                1.4.0                      py_0    intel
attrs                     21.2.0             pyhd3eb1b0_0    intel
autopep8                  1.6.0              pyhd3eb1b0_0
backports                 1.1                pyhd3eb1b0_0
backports.functools_lru_cache 1.6.4              pyhd3eb1b0_0
backports.tempfile        1.0                pyhd3eb1b0_1
backports.weakref         1.0.post1                  py_1
beautifulsoup4            4.10.0             pyh06a4308_0
blas                      1.0                         mkl
bzip2                     1.0.8            vc14h53ad9d4_9  [vc14]  intel
ca-certificates           2021.10.26           haa95532_2    intel
certifi                   2021.10.8        py39haa95532_0    intel
cffi                      1.15.0           py39h2bbff1b_0    intel
chardet                   4.0.0           py39haa95532_1003    intel
click                     8.0.3              pyhd3eb1b0_0    intel
clyent                    1.2.2            py39haa95532_1
conda                     4.12.0           py39haa95532_0
conda-build               3.21.8           py39haa95532_2
conda-content-trust       0.1.1              pyhd3eb1b0_0
conda-env                 2.6.0                haa95532_1
conda-package-handling    1.7.3            py39h8cc25b3_1    intel
conda-repo-cli            1.0.4              pyhd3eb1b0_0
conda-token               0.3.0              pyhd3eb1b0_0
conda-verify              3.4.2                      py_1
console_shortcut          0.1.1                         4
cryptography              3.3.2            py39hf425351_1    intel
cudatoolkit               11.3.1               h59b6b97_2
cudnn                     8.2.1                cuda11.3_0
cycler                    0.11.0             pyhd3eb1b0_0    intel
dpcpp-cpp-rt              2022.0.0             intel_3663    intel
dpcpp_cpp_rt              2022.0.0             intel_3663    intel
eigen                     3.3.7                h59b6b97_1
ffmpeg                    4.2.2                he774522_0
filelock                  3.6.0              pyhd3eb1b0_0
freeglut                  3.0.0                h6538335_5
freetype                  2.10.4               h43e298c_0    intel
future                    0.18.2           py39haa95532_1
git                       2.24.0                        1    conda-forge
git-bash                  2.24.0                        0    conda-forge
glob2                     0.7                pyhd3eb1b0_0
icc_rt                    2022.0.0             intel_3663    intel
icu                       68.1                 h6c2663c_0
idna                      2.10               pyhd3eb1b0_0    intel
importlib-metadata        4.11.3           py39haa95532_0
importlib_metadata        4.11.3               hd3eb1b0_0
intel-cmplr-lib-rt        2022.0.0             intel_3663    intel
intel-cmplr-lic-rt        2022.0.0             intel_3663    intel
intel-opencl-rt           2022.0.0             intel_3663    intel
intel-openmp              2022.0.0             intel_3663    intel
intelpython               2022.0.0                      0    intel
ipython_genutils          0.2.0              pyhd3eb1b0_1
jasper                    2.0.14               hea7d32e_2
jinja2                    2.11.3             pyhd3eb1b0_0
jpeg                      9d                   h2bbff1b_0
jsonschema                3.2.0              pyhd3eb1b0_2
jupyter_core              4.9.2            py39haa95532_0
kiwisolver                1.3.1            py39hd77b12b_0    intel
libarchive                3.5.2                hec01699_0    intel
libblas                   3.9.0              13_win64_mkl    conda-forge
libcblas                  3.9.0              13_win64_mkl    conda-forge
libclang                  11.1.0          default_h5c34c98_1    conda-forge
libiconv                  1.16                 h2beac5e_1    intel
liblapack                 3.9.0              13_win64_mkl    conda-forge
liblapacke                3.9.0              13_win64_mkl    conda-forge
liblief                   0.11.5               hd77b12b_1
libopencv                 4.5.0                    py39_2    conda-forge
libpng                    1.6.37           vc14h53ad9d4_8  [vc14]  intel
libtiff                   4.2.0                hd0e1b90_0
libuv                     1.40.0               he774522_0
libwebp                   1.2.2                h2bbff1b_0
libwebp-base              1.2.2                h2bbff1b_0
libxml2                   2.9.12               h8f7f88b_1    intel
lz4-c                     1.9.3                h2bbff1b_1    intel
lzo                       2.10                 hb535718_6    intel
markupsafe                2.0.1            py39h2bbff1b_0
matplotlib                3.1.2           py39h3292d09_11    intel
menuinst                  1.4.18           py39h59b6b97_0    intel
mkl                       2022.0.0           h0e2418a_796    conda-forge
mkl-service               2.4.0           py39h9dd93ce_10    intel
mkl_fft                   1.3.1            py39hd8013da_7    intel
mkl_random                1.2.2            py39he911e3a_7    intel
mkl_umath                 0.1.1           py39h4dc28bd_17    intel
navigator-updater         0.2.1                    py39_1
nbformat                  5.1.3              pyhd3eb1b0_0
ninja                     1.10.2           py39h559b2a2_3
numpy                     1.21.2           py39hec4e512_7    intel
numpy-base                1.21.2           py39h54dbe16_7    intel
openjdk                   11.0.13              h2bbff1b_0
openssl                   1.1.1n               h2bbff1b_0
packaging                 21.0             py39h1546d3d_4    intel
pillow                    9.0.1            py39hdc2b20a_0
pip                       21.2.4           py39haa95532_0    intel
pkginfo                   1.8.2              pyhd3eb1b0_0
powershell_shortcut       0.0.1                         3
psutil                    5.8.0            py39h2bbff1b_1
py-lief                   0.11.5           py39hd77b12b_1
py-opencv                 4.5.0            py39h9cd51e4_2    conda-forge
pycodestyle               2.8.0              pyhd3eb1b0_0
pycosat                   0.6.3            py39h2bbff1b_0    intel
pycparser                 2.21               pyhd3eb1b0_0    intel
pyjwt                     2.1.0              pyhd8ed1ab_0    intel
pyopenssl                 21.0.0             pyhd3eb1b0_1    intel
pyparsing                 3.0.4              pyhd3eb1b0_0    intel
pyqt                      5.12.3           py39hcbf5309_8    conda-forge
pyqt-impl                 5.12.3           py39h415ef7b_8    conda-forge
pyqt5-sip                 4.19.18          py39h415ef7b_8    conda-forge
pyqtchart                 5.12             py39h415ef7b_8    conda-forge
pyqtwebengine             5.12.1           py39h415ef7b_8    conda-forge
pyrsistent                0.18.0           py39h196d8e1_0
pysocks                   1.7.1            py39haa95532_0    intel
python                    3.9.10               h6cc024a_1    intel
python-dateutil           2.8.2                    py39_1    intel
python-libarchive-c       2.9                pyhd3eb1b0_1    intel
python_abi                3.9                      2_cp39    conda-forge
pytorch                   1.10.0          py3.9_cuda11.3_cudnn8_0    pytorch
pytorch-mutex             1.0                        cuda    pytorch
pytz                      2021.3             pyhd3eb1b0_0    intel
pywin32                   228              py39hbaba5e8_1    intel
pyyaml                    6.0              py39h2bbff1b_1    intel
qt                        5.12.9               h5909a2a_4    conda-forge
qtpy                      2.0.1              pyhd3eb1b0_0
requests                  2.25.1             pyhd3eb1b0_0    intel
ruamel_yaml               0.15.100         py39h2bbff1b_0    intel
selenium                  3.141.0         py39h2bbff1b_1000
setuptools                58.0.4           py39haa95532_0    intel
six                       1.16.0             pyhd3eb1b0_0    intel
soupsieve                 2.3.1              pyhd3eb1b0_0
sqlite                    3.38.2               h2bbff1b_0
tbb                       2021.5.0         vc14_intel_714  [vc14]  intel
tbb4py                    2021.5.0         py39_intel_714  [vc14]  intel
tcl                       8.6.10                   vc14_2  [vc14]  intel
tk                        8.6.10               he774522_3    intel
toml                      0.10.2             pyhd3eb1b0_0
torchaudio                0.10.0               py39_cu113    pytorch
torchvision               0.11.1               py39_cu113    pytorch
tqdm                      4.62.3             pyhd3eb1b0_1    intel
traitlets                 5.1.1              pyhd3eb1b0_0
typing_extensions         3.7.4.3            pyha847dfd_0    intel
ujson                     5.1.0            py39hd77b12b_0
urllib3                   1.26.6           py39h6fed32d_1    intel
vc                        14.2                 h21ff451_1    intel
vs2015_runtime            14.27.29016          h5e58377_2    intel
wheel                     0.37.0             pyhd3eb1b0_1    intel
win_inet_pton             1.1.0            py39haa95532_0    intel
wincertstore              0.2              py39haa95532_2    intel
xz                        5.2.5                h1ce30a1_2    intel
yaml                      0.2.5                he774522_0    intel
zipp                      3.6.0              pyhd3eb1b0_0    intel
zlib                      1.2.11.1         vc14hc1c5f5b_5  [vc14]  intel
zstd                      1.4.5                h9ae49aa_0    intel

------------------
System Information
------------------
      Time of this report: 4/6/2022, 12:24:06
             Machine name: ELITEBOOK
               Machine Id: {9131A80F-3366-4796-BD53-EA7FCCF25399}
         Operating System: Windows 11 专业版 64-bit (10.0, Build 22000) (22000.co_release.210604-1628)
                 Language: Chinese (Simplified) (Regional Setting: Chinese (Simplified))
      System Manufacturer: HP
             System Model: HP EliteBook 1050 G1
                     BIOS: Q72 Ver. 01.19.00 (type: UEFI)
                Processor: Intel(R) Core(TM) i7-8750H CPU @ 2.20GHz (12 CPUs), ~2.2GHz
                   Memory: 32768MB RAM
      Available OS Memory: 32574MB RAM
                Page File: 13557MB used, 23881MB available
              Windows Dir: C:\WINDOWS
          DirectX Version: DirectX 12
      DX Setup Parameters: Not found
         User DPI Setting: 120 DPI (125 percent)
       System DPI Setting: 120 DPI (125 percent)
          DWM DPI Scaling: UnKnown
                 Miracast: Available, with HDCP
Microsoft Graphics Hybrid: Supported
 DirectX Database Version: 1.3.5
           DxDiag Version: 10.00.22000.0001 64bit Unicode

---------------
Display Devices
---------------
           Card name: Intel(R) UHD Graphics 630
        Manufacturer: Intel Corporation
           Chip type: Intel(R) UHD Graphics Family
            DAC type: Internal
         Device Type: Full Device (POST)
          Device Key: Enum\PCI\VEN_8086&DEV_3E9B&SUBSYS_84E9103C&REV_00
       Device Status: 0180200A [DN_DRIVER_LOADED|DN_STARTED|DN_DISABLEABLE|DN_NT_ENUMERATOR|DN_NT_DRIVER]
 Device Problem Code: No Problem
 Driver Problem Code: Unknown
      Display Memory: 16415 MB
    Dedicated Memory: 128 MB
       Shared Memory: 16287 MB
        Current Mode: 1920 x 1080 (32 bit) (60Hz)
         HDR Support: Not Supported
    Display Topology: Internal
 Display Color Space: DXGI_COLOR_SPACE_RGB_FULL_G22_NONE_P709
     Color Primaries: Red(0.639648,0.330078), Green(0.299805,0.599609), Blue(0.149414,0.059570), White Point(0.312500,0.329102)
   Display Luminance: Min Luminance = 0.500000, Max Luminance = 270.000000, MaxFullFrameLuminance = 270.000000
        Monitor Name: Generic PnP Monitor
       Monitor Model: unknown
          Monitor Id: LGD05A9
         Native Mode: 1920 x 1080(p) (59.977Hz)
         Output Type: Internal
Monitor Capabilities: HDR Not Supported
Display Pixel Format: DISPLAYCONFIG_PIXELFORMAT_32BPP
      Advanced Color: Not Supported
         Driver Name: C:\WINDOWS\System32\DriverStore\FileRepository\iigd_dch.inf_amd64_1dc9fc8d5e442f6a\igdumdim64.dll,C:\WINDOWS\System32\DriverStore\FileRepository\iigd_dch.inf_amd64_1dc9fc8d5e442f6a\igd10iumd64.dll,C:\WINDOWS\System32\DriverStore\FileRepository\iigd_dch.inf_amd64_1dc9fc8d5e442f6a\igd10iumd64.dll,C:\WINDOWS\System32\DriverStore\FileRepository\iigd_dch.inf_amd64_1dc9fc8d5e442f6a\igd12umd64.dll
 Driver File Version: 30.00.0101.1340 (English)
      Driver Version: 30.0.101.1340
         DDI Version: 12
      Feature Levels: 12_1,12_0,11_1,11_0,10_1,10_0,9_3,9_2,9_1
        Driver Model: WDDM 3.0
 Hardware Scheduling: DriverSupportState:AlwaysOff Enabled:False
 Graphics Preemption: Triangle
  Compute Preemption: Thread
            Miracast: Supported
      Detachable GPU: No
 Hybrid Graphics GPU: Integrated
      Power P-states: Not Supported
      Virtualization: Paravirtualization
          Block List: DISABLE_HWSCH
  Catalog Attributes: Universal:False Declarative:True
   Driver Attributes: Final Retail
    Driver Date/Size: 2022/2/3 8:00:00, 1702664 bytes
         WHQL Logo'd: Yes
     WHQL Date Stamp: Unknown
   Device Identifier: {D7B78E66-7DDB-11CF-B076-8CA4AFC2D335}
           Vendor ID: 0x8086
           Device ID: 0x3E9B
           SubSys ID: 0x84E9103C
         Revision ID: 0x0000
  Driver Strong Name: oem121.inf:5f63e53429d61c21:iCFL_w10_DS:30.0.101.1340:PCI\VEN_8086&DEV_3E9B
      Rank Of Driver: 00CF2001
         Video Accel: ModeMPEG2_A ModeMPEG2_C ModeWMV9_C ModeVC1_C
         DXVA2 Modes: DXVA2_ModeMPEG2_VLD  DXVA2_ModeMPEG2_IDCT  DXVA2_ModeVC1_D2010  {E07EC519-E651-4CD6-AC84-1370CCEEC851}  {BCC5DB6D-A2B6-4AF0-ACE4-ADB1F787BC89}  DXVA2_ModeWMV9_IDCT  DXVA2_ModeVC1_IDCT  DXVA2_ModeH264_VLD_NoFGT  DXVA2_ModeH264_VLD_Stereo_Progressive_NoFGT  DXVA2_ModeH264_VLD_Stereo_NoFGT  DXVA2_ModeH264_VLD_Multiview_NoFGT  {C528916C-C0AF-4645-8CB2-372B6D4ADC2A}  {91CD2D6E-897B-4FA1-B0D7-51DC88010E0A}  DXVA2_ModeVP8_VLD  {442B942A-B4D9-4940-BC45-A882E5F919F3}  {97688186-56A8-4094-B543-FC9DAAA49F4B}  {1424D4DC-7CF5-4BB1-9CD7-B63717A72A6B}  {C346E8A3-CBED-4D27-87CC-A70EB4DC8C27}  {FFC79924-5EAF-4666-A736-06190F281443}  {2364D06A-F67F-4186-AED0-62B99E1784F1}  {464BDB3C-91C4-4E9B-896F-225496AC4ED6}  {28566328-F041-4466-8B14-8F5831E78F8B}  {6B4A94DB-54FE-4AE1-9BE4-7A7DAD004600}  {8C56EB1E-2B47-466F-8D33-7DBCD63F3DF2}  DXVA2_ModeHEVC_VLD_Main  {75FC75F7-C589-4A07-A25B-72E03B0383B3}  DXVA2_ModeHEVC_VLD_Main10  {07CFAFFB-5A2E-4B99-B62A-E4CA53B6D5AA}  DXVA2_ModeVP9_VLD_Profile0  DXVA2_ModeVP9_VLD_10bit_Profile2  {76988A52-DF13-419A-8E64-FFCF4A336CF5}  {80A3A7BD-89D8-4497-A2B8-2126AF7E6EB8}  {50925B7B-E931-4978-A12A-586630F095F9}  {B69C20E0-2508-8790-0305-875499E0A2D0}  {49761BEC-4B63-4349-A5FF-87FFDF088466}
   Deinterlace Caps: {BF752EF6-8CC4-457A-BE1B-08BD1CAEEE9F}: Format(In/Out)=(YUY2,YUY2) Frames(Prev/Fwd/Back)=(0,0,1) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_EdgeFiltering
                     {335AA36E-7884-43A4-9C91-7F87FAF3E37E}: Format(In/Out)=(YUY2,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_BOBVerticalStretch
                     {5A54A0C9-C7EC-4BD9-8EDE-F3C75DC4393B}: Format(In/Out)=(YUY2,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend
                     {BF752EF6-8CC4-457A-BE1B-08BD1CAEEE9F}: Format(In/Out)=(UYVY,YUY2) Frames(Prev/Fwd/Back)=(0,0,1) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_EdgeFiltering
                     {335AA36E-7884-43A4-9C91-7F87FAF3E37E}: Format(In/Out)=(UYVY,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_BOBVerticalStretch
                     {5A54A0C9-C7EC-4BD9-8EDE-F3C75DC4393B}: Format(In/Out)=(UYVY,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend
                     {BF752EF6-8CC4-457A-BE1B-08BD1CAEEE9F}: Format(In/Out)=(YV12,YUY2) Frames(Prev/Fwd/Back)=(0,0,1) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_EdgeFiltering
                     {335AA36E-7884-43A4-9C91-7F87FAF3E37E}: Format(In/Out)=(YV12,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_BOBVerticalStretch
                     {5A54A0C9-C7EC-4BD9-8EDE-F3C75DC4393B}: Format(In/Out)=(YV12,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend
                     {BF752EF6-8CC4-457A-BE1B-08BD1CAEEE9F}: Format(In/Out)=(NV12,YUY2) Frames(Prev/Fwd/Back)=(0,0,1) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_EdgeFiltering
                     {335AA36E-7884-43A4-9C91-7F87FAF3E37E}: Format(In/Out)=(NV12,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_BOBVerticalStretch
                     {5A54A0C9-C7EC-4BD9-8EDE-F3C75DC4393B}: Format(In/Out)=(NV12,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend
                     {BF752EF6-8CC4-457A-BE1B-08BD1CAEEE9F}: Format(In/Out)=(IMC1,YUY2) Frames(Prev/Fwd/Back)=(0,0,1) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_EdgeFiltering
                     {335AA36E-7884-43A4-9C91-7F87FAF3E37E}: Format(In/Out)=(IMC1,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_BOBVerticalStretch
                     {5A54A0C9-C7EC-4BD9-8EDE-F3C75DC4393B}: Format(In/Out)=(IMC1,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend
                     {BF752EF6-8CC4-457A-BE1B-08BD1CAEEE9F}: Format(In/Out)=(IMC2,YUY2) Frames(Prev/Fwd/Back)=(0,0,1) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_EdgeFiltering
                     {335AA36E-7884-43A4-9C91-7F87FAF3E37E}: Format(In/Out)=(IMC2,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_BOBVerticalStretch
                     {5A54A0C9-C7EC-4BD9-8EDE-F3C75DC4393B}: Format(In/Out)=(IMC2,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend
                     {BF752EF6-8CC4-457A-BE1B-08BD1CAEEE9F}: Format(In/Out)=(IMC3,YUY2) Frames(Prev/Fwd/Back)=(0,0,1) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_EdgeFiltering
                     {335AA36E-7884-43A4-9C91-7F87FAF3E37E}: Format(In/Out)=(IMC3,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_BOBVerticalStretch
                     {5A54A0C9-C7EC-4BD9-8EDE-F3C75DC4393B}: Format(In/Out)=(IMC3,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend
                     {BF752EF6-8CC4-457A-BE1B-08BD1CAEEE9F}: Format(In/Out)=(IMC4,YUY2) Frames(Prev/Fwd/Back)=(0,0,1) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_EdgeFiltering
                     {335AA36E-7884-43A4-9C91-7F87FAF3E37E}: Format(In/Out)=(IMC4,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend DeinterlaceTech_BOBVerticalStretch
                     {5A54A0C9-C7EC-4BD9-8EDE-F3C75DC4393B}: Format(In/Out)=(IMC4,YUY2) Frames(Prev/Fwd/Back)=(0,0,0) Caps=VideoProcess_YUV2RGB VideoProcess_StretchX VideoProcess_StretchY VideoProcess_AlphaBlend
        D3D9 Overlay: Supported
             DXVA-HD: Supported
        DDraw Status: Enabled
          D3D Status: Enabled
          AGP Status: Enabled
       MPO MaxPlanes: 3
            MPO Caps: RGB,YUV,BILINEAR,HIGH_FILTER,STRETCH_YUV,STRETCH_RGB,IMMEDIATE,HDR (MPO3)
         MPO Stretch: 5.000X - 0.334X
     MPO Media Hints: colorspace Conversion
         MPO Formats: NV12,YUY2,R16G16B16A16_FLOAT,R10G10B10A2_UNORM,R8G8B8A8_UNORM,B8G8R8A8_UNORM
    PanelFitter Caps: RGB,YUV,BILINEAR,HIGH_FILTER,STRETCH_YUV,STRETCH_RGB,IMMEDIATE,HDR (MPO3)
 PanelFitter Stretch: 5.000X - 0.334X
   Component Drivers:
             Driver Name: Unknown
          Driver Version: Unknown
             Driver Date: Unknown
         Driver Provider: Unknown
      Catalog Attributes: N/A
             Driver Name: Unknown
          Driver Version: Unknown
             Driver Date: Unknown
         Driver Provider: Unknown
      Catalog Attributes: N/A

           Card name: NVIDIA GeForce GTX 1050 with Max-Q Design
        Manufacturer: NVIDIA
           Chip type: NVIDIA GeForce GTX 1050 with Max-Q Design
            DAC type: Integrated RAMDAC
         Device Type: Full Device
          Device Key: Enum\PCI\VEN_10DE&DEV_1C8D&SUBSYS_84E9103C&REV_A1
       Device Status: 0180200A [DN_DRIVER_LOADED|DN_STARTED|DN_DISABLEABLE|DN_NT_ENUMERATOR|DN_NT_DRIVER]
 Device Problem Code: No Problem
 Driver Problem Code: Unknown
      Display Memory: 20306 MB
    Dedicated Memory: 4019 MB
       Shared Memory: 16287 MB
        Current Mode: Unknown
         HDR Support: Unknown
    Display Topology: Unknown
 Display Color Space: Unknown
     Color Primaries: Unknown
   Display Luminance: Unknown
         Driver Name: C:\WINDOWS\System32\DriverStore\FileRepository\nvbli.inf_amd64_c1e7d53215dee65d\nvldumdx.dll,C:\WINDOWS\System32\DriverStore\FileRepository\nvbli.inf_amd64_c1e7d53215dee65d\nvldumdx.dll,C:\WINDOWS\System32\DriverStore\FileRepository\nvbli.inf_amd64_c1e7d53215dee65d\nvldumdx.dll,C:\WINDOWS\System32\DriverStore\FileRepository\nvbli.inf_amd64_c1e7d53215dee65d\nvldumdx.dll
 Driver File Version: 30.00.0015.1006 (English)
      Driver Version: 30.0.15.1006
         DDI Version: 12
      Feature Levels: 12_1,12_0,11_1,11_0,10_1,10_0,9_3,9_2,9_1
        Driver Model: WDDM 3.0
 Hardware Scheduling: DriverSupportState:Stable Enabled:True
 Graphics Preemption: Pixel
  Compute Preemption: Dispatch
            Miracast: Not Supported by Graphics driver
      Detachable GPU: No
 Hybrid Graphics GPU: Discrete
      Power P-states: Not Supported
      Virtualization: Paravirtualization
          Block List: No Blocks
  Catalog Attributes: Universal:False Declarative:True
   Driver Attributes: Final Retail
    Driver Date/Size: 2021/8/24 8:00:00, 1056920 bytes
         WHQL Logo'd: Yes
     WHQL Date Stamp: Unknown
   Device Identifier: Unknown
           Vendor ID: 0x10DE
           Device ID: 0x1C8D
           SubSys ID: 0x84E9103C
         Revision ID: 0x00A1
  Driver Strong Name: oem21.inf:0f066de303554110:Section032:30.0.15.1006:pci\ven_10de&dev_1c8d&subsys_84e9103c
      Rank Of Driver: 00CF0001
         Video Accel: Unknown
         DXVA2 Modes: {86695F12-340E-4F04-9FD3-9253DD327460}  DXVA2_ModeMPEG2_VLD  {6F3EC719-3735-42CC-8063-65CC3CB36616}  DXVA2_ModeVC1_D2010  DXVA2_ModeVC1_VLD  {32FCFE3F-DE46-4A49-861B-AC71110649D5}  DXVA2_ModeH264_VLD_Stereo_Progressive_NoFGT  DXVA2_ModeH264_VLD_Stereo_NoFGT  DXVA2_ModeH264_VLD_NoFGT  DXVA2_ModeHEVC_VLD_Main  DXVA2_ModeHEVC_VLD_Main10  {20BB8B0A-97AA-4571-8E99-64E60606C1A6}  {15DF9B21-06C4-47F1-841E-A67C97D7F312}  DXVA2_ModeMPEG4pt2_VLD_Simple  DXVA2_ModeMPEG4pt2_VLD_AdvSimple_NoGMC  {9947EC6F-689B-11DC-A320-0019DBBC4184}  {33FCFE41-DE46-4A49-861B-AC71110649D5}  DXVA2_ModeVP9_VLD_Profile0  DXVA2_ModeVP9_VLD_10bit_Profile2  {DDA19DC7-93B5-49F5-A9B3-2BDA28A2CE6E}  {6AFFD11E-1D96-42B1-A215-93A31F09A53D}  {914C84A3-4078-4FA9-984C-E2F262CB5C9C}
      Deinterlace Caps: n/a
        D3D9 Overlay: Unknown
             DXVA-HD: Unknown
        DDraw Status: Enabled
          D3D Status: Enabled
          AGP Status: Enabled
       MPO MaxPlanes: 0
            MPO Caps: Not Supported
         MPO Stretch: Not Supported
     MPO Media Hints: Not Supported
         MPO Formats: Not Supported
    PanelFitter Caps: Not Supported
 PanelFitter Stretch: Not Supported

-------------
Sound Devices
-------------
            Description: 扬声器 (Conexant ISST Audio)
 Default Sound Playback: Yes
 Default Voice Playback: Yes
            Hardware ID: INTELAUDIO\FUNC_01&VEN_14F1&DEV_20D0&SUBSYS_103C84E9&REV_1000
        Manufacturer ID: N/A
             Product ID: N/A
                   Type: N/A
            Driver Name: CHDRT64ISST.sys
         Driver Version: 9.0.278.150 (Chinese (Simplified))
      Driver Attributes: Final Retail
            WHQL Logo'd: Yes
          Date and Size: 2021/11/18 8:00:00, 2521920 bytes
            Other Files:
        Driver Provider: Conexant
         HW Accel Level: Emulation Only
              Cap Flags: 0xF1F
    Min/Max Sample Rate: 100, 200000
Static/Strm HW Mix Bufs: 1, 0
 Static/Strm HW 3D Bufs: 0, 0
              HW Memory: 0
       Voice Management: No
 EAX(tm) 2.0 Listen/Src: No, No
   I3DL2(tm) Listen/Src: No, No
Sensaura(tm) ZoomFX(tm): No

---------------------
Sound Capture Devices
---------------------
            Description: 麦克风 (Conexant ISST Audio)
  Default Sound Capture: Yes
  Default Voice Capture: Yes
            Driver Name: CHDRT64ISST.sys
         Driver Version: 9.0.278.150 (Chinese (Simplified))
      Driver Attributes: Final Retail
          Date and Size: 2021/11/18 8:00:00, 2521920 bytes
              Cap Flags: 0x1
           Format Flags: 0xFFFFF

-------------------
DirectInput Devices
-------------------
      Device Name: 鼠标
         Attached: 1
    Controller ID: n/a
Vendor/Product ID: n/a
        FF Driver: n/a

      Device Name: 键盘
         Attached: 1
    Controller ID: n/a
Vendor/Product ID: n/a
        FF Driver: n/a

      Device Name: USB Receiver
         Attached: 1
    Controller ID: 0x0
Vendor/Product ID: 0x046D, 0xC53F
        FF Driver: n/a

      Device Name: USB Receiver
         Attached: 1
    Controller ID: 0x0
Vendor/Product ID: 0x046D, 0xC53F
        FF Driver: n/a

      Device Name: USB Receiver
         Attached: 1
    Controller ID: 0x0
Vendor/Product ID: 0x046D, 0xC53F
        FF Driver: n/a

      Device Name: USB Receiver
         Attached: 1
    Controller ID: 0x0
Vendor/Product ID: 0x046D, 0xC53F
        FF Driver: n/a

      Device Name: HP Wireless Button Driver
         Attached: 1
    Controller ID: 0x0
Vendor/Product ID: 0x0001, 0x0001
        FF Driver: n/a

      Device Name: USB Receiver
         Attached: 1
    Controller ID: 0x0
Vendor/Product ID: 0x046D, 0xC53F
        FF Driver: n/a

      Device Name: HIDI2C Device
         Attached: 1
    Controller ID: 0x0
Vendor/Product ID: 0x06CB, 0xCD46
        FF Driver: n/a

      Device Name: USB Receiver
         Attached: 1
    Controller ID: 0x0
Vendor/Product ID: 0x046D, 0xC53F
        FF Driver: n/a

      Device Name: HIDI2C Device
         Attached: 1
    Controller ID: 0x0
Vendor/Product ID: 0x06CB, 0xCD46
        FF Driver: n/a

Poll w/ Interrupt: No

-----------
USB Devices
-----------
+ USB 根集线器(USB 3.0)
| Vendor/Product ID: 0x8086, 0xA36D
| Matching Device ID: USB\ROOT_HUB30
| Service: USBHUB3
| Driver: USBHUB3.SYS, 8/1/2021 11:33:15, 696656 bytes
|
+-+ USB Composite Device
| | Vendor/Product ID: 0x046D, 0xC53F
| | Location: Port_#0005.Hub_#0001
| | Matching Device ID: USB\COMPOSITE
| | Service: usbccgp
| | Driver: usbccgp.sys, 6/5/2021 20:04:46, 221512 bytes
| |
| +-+ USB 输入设备
| | | Vendor/Product ID: 0x046D, 0xC53F
| | | Location: 0000.0014.0000.005.000.000.000.000.000
| | | Matching Device ID: USB\Class_03&SubClass_01
| | | Service: HidUsb
| | | Driver: hidusb.sys, 6/5/2021 20:04:46, 73728 bytes
| | | Driver: hidclass.sys, 6/5/2021 20:04:46, 274432 bytes
| | | Driver: hidparse.sys, 6/5/2021 20:04:46, 77824 bytes
| | |
| | +-+ HID Keyboard Device
| | | | Vendor/Product ID: 0x046D, 0xC53F
| | | | Matching Device ID: HID_DEVICE_SYSTEM_KEYBOARD
| | | | Service: kbdhid
| | | | Driver: kbdhid.sys, 6/5/2021 20:04:46, 69632 bytes
| | | | Driver: kbdclass.sys, 6/5/2021 20:04:46, 90424 bytes
| | |
| +-+ USB 输入设备
| | | Vendor/Product ID: 0x046D, 0xC53F
| | | Location: 0000.0014.0000.005.000.000.000.000.000
| | | Matching Device ID: USB\Class_03&SubClass_01
| | | Service: HidUsb
| | | Driver: hidusb.sys, 6/5/2021 20:04:46, 73728 bytes
| | | Driver: hidclass.sys, 6/5/2021 20:04:46, 274432 bytes
| | | Driver: hidparse.sys, 6/5/2021 20:04:46, 77824 bytes
| | |
| | +-+ HID-compliant mouse
| | | | Vendor/Product ID: 0x046D, 0xC53F
| | | | Matching Device ID: HID_DEVICE_SYSTEM_MOUSE
| | | | Service: mouhid
| | | | Driver: mouhid.sys, 6/5/2021 20:04:46, 65536 bytes
| | | | Driver: mouclass.sys, 6/5/2021 20:04:46, 90448 bytes

------------
PS/2 Devices
------------
+ Standard 101/102-Key or Microsoft Natural PS/2 Keyboard for HP Hotkey Support
| Matching Device ID: ACPI\HPQ8002
| Upper Filters: HpqKbFiltr
| Service: i8042prt
| Driver: HpqKbFiltr.sys, 10/30/2021 14:34:06, 54688 bytes
| Driver: i8042prt.sys, 6/5/2021 20:04:46, 155648 bytes
| Driver: kbdclass.sys, 6/5/2021 20:04:46, 90424 bytes
|
+ Synaptics HID ClickPad
| Vendor/Product ID: 0x06CB, 0x0000
| Matching Device ID: HID\SYNA307B&Col01
| Upper Filters: SynTP
| Service: mouhid
| Driver: SynTP.sys, 1/20/2021 23:58:02, 762256 bytes
| Driver: SynTPEnh.exe, 1/20/2021 23:58:04, 4287888 bytes
| Driver: SynTPRes.dll, 1/20/2021 23:58:02, 19816336 bytes
| Driver: SynTPAPI.dll, 1/20/2021 23:58:00, 275344 bytes
| Driver: SynCOM.dll, 1/20/2021 23:57:56, 810384 bytes
| Driver: SynTPEnhService.exe, 1/20/2021 23:58:00, 342416 bytes
| Driver: mouhid.sys, 6/5/2021 20:04:46, 65536 bytes
| Driver: mouclass.sys, 6/5/2021 20:04:46, 90448 bytes
|
+ PS/2 兼容鼠标
| Matching Device ID: *PNP0F13
| Service: i8042prt
| Driver: mouclass.sys, 6/5/2021 20:04:46, 90448 bytes
| Driver: i8042prt.sys, 6/5/2021 20:04:46, 155648 bytes

------------------------
Disk & DVD/CD-ROM Drives
------------------------
      Drive: C:
 Free Space: 359.5 GB
Total Space: 952.9 GB
File System: NTFS
      Model: Intel Raid 1 Volume

'''


from typing import Iterable, Tuple, Union
import cv2
import numpy as np
from enum import Enum

BorderTypes = Enum(
    'BorderTypes', ('BORDER_CONSTANT BORDER_REPLICATE'))  # 预定义可能的边界类型
ThresholdTypes = Enum(
    'ThresholdTypes', ('THRESH_BINARY THRESH_BINARY_INV THRESH_TRUNC THRESH_TOZERO THRESH_TOZERO_INV'))  # 预定义可能的阈值类型
HoughModes = Enum('HoughModes', ('HOUGH_GRADIENT '))  # 预定义可能的霍夫变换的变体


class UnionFindSet:
    '''Disjoint-set'''

    def __init__(self, maxSize: int) -> None:
        '''Initialize all possible nodes' parents and ranks'''

        # allocate memory, a root is represented by a node that points to itself
        self.__parent = [i for i in range(maxSize)]
        # store rank for more efficient union
        self.__rank = [0]*maxSize

    def find(self, x: int) -> int:
        '''Finding set representatives with splitting algorithm'''

        # one-pass find
        while self.__parent[x] != x:
            #  update the parent pointers of nodes on the path between the query node and the root, and replace every parent pointer by a pointer to the node's grandparent
            x, self.__parent[x] = self.__parent[x], self.__parent[self.__parent[x]]

        return x  # return result

    def union(self, x: int, y: int) -> None:
        '''
        Unioning by rank.

        To merge trees with roots `x` and `y`, first compare their ranks.

        If the ranks are different,
        then the larger rank tree becomes the parent,
        and the ranks of `x` and `y` do not change.

        If the ranks are the same, then either one can become the parent,
        but the new parent's rank is incremented by one.
        '''

        if x == y:  # x and y are already the same
            return  # halt now

        x = self.find(x)  # Replace node by root
        y = self.find(y)  # Replace node by root

        if x == y:  # x and y are already in the same set
            return  # halt now

        # If necessary, exchange variables to ensure that x has a rank at least as large as that of y
        if self.__rank[x] < self.__rank[y]:
            x, y = y, x

        self.__parent[y] = x  # Make x the new root

        # If necessary, increment the rank of x
        if self.__rank[x] == self.__rank[y]:
            self.__rank[x] += 1

        return  # halt


def BGR2GRAY(src: np.ndarray) -> np.ndarray:
    '''将RGB图转为8位灰度图'''

    tmp = src.astype(np.uint32)  # 用32位整型存储防止溢出

    # RGB to Gray: Y←0.299⋅R+0.587⋅G+0.114⋅B
    return ((tmp[:, :, 2]*299 + tmp[:, :, 1]*587 + tmp[:, :, 0]*114+500)//1000).astype(np.uint8)


def copyMakeBorder(src: np.ndarray, top: int, bottom: int, left: int, right: int,
                   borderType: BorderTypes, value: int = 0) -> np.ndarray:
    '''图像边缘填充'''

    height, width = src.shape  # 获得原图长宽

    dst = np.empty((height+top+bottom, width+left+right),
                   dtype=src.dtype)  # 分配空间
    dst[top: height+top, left: width+left] = src.copy()  # 载入原图

    if borderType is BorderTypes.BORDER_CONSTANT:  # iiiiii|abcdefgh|iiiiiii with i specified by value
        # pad top
        dst[:top, left: width+left] = value
        # pad bottom
        dst[height+top:, left: width+left] = value
        # pad left
        dst[:, :left] = value
        # pad right
        dst[:, width+left:] = value

    elif borderType is BorderTypes.BORDER_REPLICATE:  # aaaaaa|abcdefgh|hhhhhhh

        # pad top
        dst[:top, left: width + left] = np.tile(
            dst[top, left: width+left].reshape(1, -1), (top, 1))

        # pad bottom
        dst[height+top:, left: width +
            left] = np.tile(
                dst[height+top-1, left: width+left].reshape(1, -1), (bottom, 1))

        # pad left
        dst[:, :left] = np.tile(
            dst[:, left].reshape(-1, 1), (1, left))

        # pad right
        dst[:, width+left:] = np.tile(
            dst[:, width+left-1].reshape(-1, 1), (1, right))

    return dst  # return result


def convertScaleAbs(src: np.ndarray) -> np.ndarray:
    '''取绝对值并截断为int8'''
    return np.abs(src).clip(0, 255).astype(np.uint8)  # 和OpenCV算法保持一致


def threshold(src: np.ndarray, thresh: float, maxval: float, type: ThresholdTypes) -> Tuple[float, np.ndarray]:
    '''Applies a fixed-level threshold to each array element'''

    retval, dst = float(), np.empty_like(src)  # 分配空间

    if type is ThresholdTypes.THRESH_BINARY:  # 黑白二值
        retval, dst = thresh, np.where((src > thresh), maxval, 0)
    elif type is ThresholdTypes.THRESH_BINARY_INV:  # 黑白二值反转
        retval, dst = thresh, np.where((src > thresh), 0, maxval)
    elif type is ThresholdTypes.THRESH_TRUNC:  # 截断
        retval, dst = thresh, np.where((src > thresh), thresh, src)
    elif type is ThresholdTypes.THRESH_TOZERO:  # 小值置零
        retval, dst = thresh, np.where((src > thresh), src, 0)
    elif type is ThresholdTypes.THRESH_TOZERO_INV:  # 大值置零
        retval, dst = thresh, np.where((src > thresh), 0, src)

    return retval, dst


def filter2D(src: np.ndarray,  dtype: type, kernel: np.ndarray, borderType: BorderTypes = BorderTypes.BORDER_REPLICATE) -> np.ndarray:
    '''Convolves an image with the kernel'''

    height, width = src.shape  # 获得图像长宽
    kerlSize = kernel.shape[0]  # 卷积核大小

    # 边缘填充
    imgPadded = copyMakeBorder(src,  kerlSize//2, kerlSize//2, kerlSize //
                               2, kerlSize//2, borderType=borderType)

    # allocate memory for result,note that the default type is float64 to ensure accuracy
    dst = np.empty_like(src, dtype=np.float64)

    # 事实上不分解卷积核更快
    # filtering
    for y in range(height):  # 对所有行
        for x in range(width):  # 对所有列
            dst[y, x] = np.sum(
                kernel*(imgPadded[y: y + kerlSize, x: x + kerlSize]), dtype=dtype)  # 卷积

    return dst  # return result


def rankFilter(src: np.ndarray, kth: int, kernel: np.ndarray,
               borderType: BorderTypes = BorderTypes.BORDER_REPLICATE, value: int = 0) -> np.ndarray:
    '''排序滤波'''

    height, width = src.shape  # 获得图像长宽
    kh, kw = kernel.shape  # 获得卷积核长宽
    imgPadded = copyMakeBorder(
        src,  kh//2, kh//2, kw//2, kw//2, borderType, value)  # 边缘填充
    dst = np.empty_like(src)  # allocate memory for result

    # filtering
    for y in range(height):  # 对所有行
        for x in range(width):  # 对所有列
            # 选取窗口中从小往大数kth位的像素值
            dst[y, x] = np.partition(
                np.multiply(imgPadded[y: y+kh, x: x+kw], kernel, dtype=src.dtype).flatten(), kth)[kth]

    return dst  # return result


def dilate(src: np.ndarray, kernel: np.ndarray, iterations: int = 1,
           borderType: BorderTypes = BorderTypes.BORDER_REPLICATE, borderValue: int = 0) -> np.ndarray:
    '''Dilates an image by using a specific structuring element'''

    if iterations <= 0:  # 判断迭代次数是否有效
        raise ValueError

    dst = np.empty_like(src)  # 分配空间

    while iterations:  # 循环迭代
        iterations -= 1  # 迭代次数自减1
        dst = rankFilter(src, -1, kernel, borderType, borderValue)  # 取结构元素中最大值

    return dst  # return result


def GaussianBlur(src: np.ndarray, ksize: int, sigma: float, borderType: BorderTypes = BorderTypes.BORDER_REPLICATE) -> np.ndarray:
    '''Blurs an image using a Gaussian filter'''

    kerl = np.empty((ksize, ksize), dtype=np.float16)  # 为卷积核分配空间
    cter = ksize // 2  # 卷积核的中心位置

    for i in range(ksize):  # 对卷积核的每行
        for j in range(ksize):  # 对卷积核的每列
            # 计算卷积核中每个元素的值，注意到(1/2πσ)系数的计算是不必要的，因为会在归一化中被消去
            kerl[i][j] = np.exp(-((i-cter)**2+(j-cter)**2) / (2*sigma**2))

    kerl /= kerl.sum()  # 归一化，避免影响图像明度

    # 构造高斯滤波器
    dst = filter2D(src, src.dtype, kerl, borderType)

    return dst  # return result


def Sobel(src: np.ndarray, dtype: type, dx: int, dy: int, borderType: BorderTypes = BorderTypes.BORDER_REPLICATE) -> np.ndarray:
    '''Sobel滤波'''

    if dx == 1 and dy == 0:
        # x方向Sobel算子
        kerl = np.array([[-1, 0, 1],
                         [-2, 0, 2],
                         [-1, 0, 1]])
    elif dx == 0 and dy == 1:
        # y方向Sobel算子
        kerl = np.array([[-1, -2, -1],
                        [0, 0, 0],
                        [1, 2, 1]])
    else:
        raise ValueError

    # 构造Sobel滤波器，注意到未归一化，和OpenCV的实现保持一致
    dst = filter2D(src, dtype, kerl, borderType)

    return dst  # return result


def nonmaximumSuppression(gradientMagnitude: np.ndarray, gradientDirection: np.ndarray) -> np.ndarray:
    '''非极大值抑制'''

    direction = np.where(gradientDirection < 0,
                         gradientDirection+np.pi, gradientDirection)  # 映射到[0, 180°]，相差180°的被认为是同一方向
    # [0°, 22.5°]映射为0，(22.5°, 67.5°)映射为1，[67.5°, 112.5°]映射为2，(112.5°, 157.5°)映射为3，[157.5°, 180°]映射为4
    direction = np.around(direction/np.pi*4).astype(np.uint8)
    direction[direction == 4] = 0  # [0°, 22.5°]和[157.5°, 180°]表示相同方向

    maskEW = np.array([[1, 1, 1]])  # 0°方向滤波核
    maskNWSE = np.array([[1, 0, 0],
                         [0, 1, 0],
                         [0, 0, 1]])  # 45°方向滤波核
    maskNS = np.array([[1],
                       [1],
                       [1]])  # 90°方向滤波核
    maskNESW = np.array([[0, 0, 1],
                         [0, 1, 0],
                         [1, 0, 0]])  # 135°方向滤波核

    maxEW = dilate(gradientMagnitude, maskEW,
                   borderType=BorderTypes.BORDER_CONSTANT)  # 0°方向最大值
    maxEW[direction != 0] = 0  # 忽略实际梯度方向不为0°的结果

    maxNWSE = dilate(gradientMagnitude,  maskNWSE,
                     borderType=BorderTypes.BORDER_CONSTANT)  # 45°方向最大值
    maxNWSE[direction != 1] = 0  # 忽略实际梯度方向不为45°的结果

    maxNS = dilate(gradientMagnitude,  maskNS,
                   borderType=BorderTypes.BORDER_CONSTANT)   # 90°方向最大值
    maxNS[direction != 2] = 0  # 忽略实际梯度方向不为90°的结果

    maxNESW = dilate(gradientMagnitude,  maskNESW,
                     borderType=BorderTypes.BORDER_CONSTANT)   # 135°方向最大值
    maxNESW[direction != 3] = 0  # 忽略实际梯度方向不为135°的结果

    maxMerged = maxEW+maxNWSE+maxNS+maxNESW  # 合并四个方向的结果

    magnitude = np.where((gradientMagnitude == maxMerged),
                         gradientMagnitude, 0)  # 查表，非极大值抑制

    return magnitude  # return result


def doubleThreshold(gradientMagnitude: np.ndarray, threshold1: float, threshold2: float) -> Tuple[np.ndarray, np.ndarray]:
    '''双阈值处理'''

    strongEdge = np.where((gradientMagnitude >= threshold2),
                          gradientMagnitude, 0)  # 梯度值∈[高阈值, +∞)——强边缘
    weakEdge = np.where((gradientMagnitude < threshold2) & (gradientMagnitude >= threshold1),
                        gradientMagnitude, 0)   # 梯度值∈[低阈值, 高阈值)——弱边缘

    return strongEdge, weakEdge  # return result


def blobAnalysis(src: np.ndarray, dtype: type = np.uint32) -> np.ndarray:
    '''Connected-component labeling, two-pass algorithm'''

    height, width = src.shape  # 获得图像长宽

    # 为保存标号分配空间，扩大尺寸是为减少判断，
    labels = np.zeros((height+1, width+2), dtype=dtype)
    unionFindSet = UnionFindSet(np.iinfo(labels.dtype).max+1)  # 为并查集分配空间

    currentLabel = 0  # 初始化标号
    # First pass
    for i in range(height):  # 对所有行
        for j in range(width):  # 对所有列
            if src[i, j]:  # 若不是背景像素
                labelW = labels[i+1, j]  # 获取左方像素标号
                labelNW = labels[i, j]  # 获取左上方像素标号
                labelN = labels[i, j+1]  # 获取上方像素标号
                labelNE = labels[i, j+2]  # 获取右上方像素标号
                labelSet = {labelW, labelNW, labelN, labelNE}  # 相邻像素标号集合
                if labelSet == {0}:  # 若四个相邻像素均为背景
                    currentLabel += 1  # 标号自增一
                    labels[i+1, j+1] = currentLabel  # 该位置分配一个新标号
                else:  # 若四个相邻像素中至少有一个非背景，即已被标记过
                    labelSet -= {0}  # 剔除背景标号
                    minLabel = min(labelSet)  # 求邻域中最小的标号
                    labels[i+1, j+1] = minLabel  # 当前位置标号取邻域中最小值
                    for l in labelSet:  # 对于邻域中出现的所有标号
                        unionFindSet.union(minLabel, l)  # 将这些标号标记为相互联通

    labels = labels[1:, 1: -1]  # 裁剪回原图大小

    # Second pass
    for i in range(height):  # 对所有行
        for j in range(width):  # 对所有列
            if labels[i, j]:  # 若不是背景像素
                labels[i, j] = unionFindSet.find(labels[i, j])  # 合并联通区域标号

    return labels  # return result


def edgeTrackingByHysteresis(strongEdge: np.ndarray, weakEdge: np.ndarray) -> np.ndarray:
    '''滞后边界跟踪'''

    possibleEdge = strongEdge+weakEdge  # 所有可能的边缘
    # 获取联通区域标号，这里假定标号的个数不超过UINT16_MAX
    labels = blobAnalysis(possibleEdge, np.uint16)
    finalEdge = np.zeros_like(possibleEdge)  # 为最终结果分配空间并初始化

    finalLabels = np.unique(labels[strongEdge != 0])  # 获取强边缘标号
    for l in finalLabels:  # 对所有强边缘标号
        # 将该标号下所有边缘添加到最终结果
        finalEdge += np.where((labels == l), possibleEdge, 0)

    return finalEdge  # return result


def line(img: np.ndarray, x: int, y: int, dx: float, dy: float, color: int = 1) -> None:
    '''在原图上根据起点和斜率绘制贯穿图像的直线，DDA算法'''

    height, width = img.shape  # 获得图像长宽

    if abs(dx) > abs(dy):  # k∈(-1, 1)
        eps = dx  # 以x为基准变化坐标
    else:
        eps = dy  # 以y为基准变化坐标

    deltaX = dx/eps  # 恒小于等于1
    deltaY = dy/eps  # 恒小于等于1

    curY, curX = y, x  # 当前点
    curYRound, curXRound = round(curY), round(curX)  # 栅格化
    while 0 <= curXRound < width and 0 <= curYRound < height:  # 当前点在图像边界内
        img[curYRound, curXRound] += color  # 增加灰度值，不考虑灰度溢出
        curX += deltaX  # 计算下一步的x坐标
        curY += deltaY  # 计算下一步的y坐标
        curYRound, curXRound = round(curY), round(curX)  # 栅格化

    curY, curX = y-deltaY, x-deltaX  # 换向
    curYRound, curXRound = round(curY), round(curX)  # 栅格化
    while 0 <= curXRound < width and 0 <= curYRound < height:  # 当前点在图像边界内
        img[curYRound, curXRound] += color  # 增加灰度值，不考虑灰度溢出
        curX -= deltaX  # 计算下一步的x坐标
        curY -= deltaY  # 计算下一步的y坐标
        curYRound, curXRound = round(curY), round(curX)  # 栅格化

    return  # return result


def checkDistance(centers: Iterable, center: np.ndarray, minDist: float) -> bool:
    '''检测范围内有无其它圆心'''

    goodPoint = True  # 初始化标记

    for pt in centers:  # 遍历所有点
        if np.linalg.norm(center-pt, ord=2) < minDist:  # 如果与待评估点距离小于阈值
            goodPoint = False  # 待评估点应被抑制
            break  # 毋须继续比较

    return goodPoint  # return result


def Canny(image: np.ndarray, threshold1: float, threshold2: float,
          debug: bool = False) -> Union[np.ndarray, Tuple[np.ndarray, Tuple[np.ndarray, ...]]]:
    '''Finds edges in an image using the Canny algorithm'''

    gradx = Sobel(image, np.float16, 1, 0,
                  BorderTypes.BORDER_REPLICATE)  # x方向梯度
    grady = Sobel(image, np.float16, 0, 1,
                  BorderTypes.BORDER_REPLICATE)  # y方向梯度

    magnitude = np.hypot(gradx, grady)  # 梯度幅值
    direction = np.arctan2(grady, gradx)  # 梯度方向

    suppressedMag = nonmaximumSuppression(magnitude, direction)  # 非极大值抑制
    strongEdge, weakEdge = doubleThreshold(
        suppressedMag, threshold1, threshold2)  # 双阈值处理
    preservedEdge = edgeTrackingByHysteresis(strongEdge, weakEdge)  # 滞后边界跟踪
    _, edges = threshold(preservedEdge, 0, 255,
                         ThresholdTypes.THRESH_BINARY)  # 二值化

    if debug:  # 调试模式下
        # 返回值包括中间信息
        return edges, (gradx, grady, magnitude, direction, suppressedMag, strongEdge, weakEdge, preservedEdge)

    return edges  # 返回检测到的二值化边缘


def HoughCircles(image: np.ndarray, method: HoughModes, dp: float, minDist: float,
                 param1: float = 100, param2: float = 100,
                 minRadius: int = 0, maxRadius: int = 0, debug: bool = False) -> Union[np.ndarray, Tuple[np.ndarray, Tuple[np.ndarray, ...]]]:
    '''Finds circles in a grayscale image using the Hough transform'''

    if method is not HoughModes.HOUGH_GRADIENT:
        raise ValueError  # 抛出异常

    height, width = image.shape  # 获得图像长宽
    scaledH, scaledW = round(height/dp), round(width/dp)  # 缩放到累加器长宽

    edges, (gradx, grady, _, _, _, _, _, _) = Canny(
        image, max(1, param1/2), param1, debug=True)  # Canny检测边缘和梯度

    accumulator = np.zeros((scaledH, scaledW), dtype=np.uint32)  # 初始化累加器

    for y in range(height):  # 对所有行
        for x in range(width):  # 对所有列
            if edges[y, x] != 0:  # 若为边缘
                scaledY, scaledX = round(y/dp), round(x/dp)  # 计算缩放后的坐标
                gradX, gradY = gradx[y, x], grady[y, x]  # 获取当前位置梯度
                line(accumulator, scaledX, scaledY, gradX, gradY, 1)  # 沿梯度方向画线

    parameterSpace = accumulator.copy()  # 供调试用

    # 抑制小于阈值点
    accumulator[(accumulator < param2)] = 0

    minDist /= dp  # 缩放距离阈值

    cters = np.argwhere(accumulator)  # 获取所有可能中心点坐标
    votes = accumulator[(accumulator != 0)]  # 获取所有可能中心点投票数
    priorities = np.argsort(votes)[::-1]  # 票数多的索引在前
    centreCoords = []  # 存储圆心坐标
    for idx in priorities:  # 从票数多的索引开始遍历
        cter = cters[idx]  # 暂存当前点坐标
        goodPoint = checkDistance(centreCoords, cter, minDist)  # 检查是否和已被确认点过近
        if goodPoint:  # 如果检查通过
            centreCoords.append(cter)  # 将之添加到确认点列表

    if maxRadius <= 0:  # 如果半径上限小于等于0
        maxRadius = int(np.hypot(scaledH, scaledW))+1  # 半径上限取对角线长
    else:  # 否则
        maxRadius = round(maxRadius/dp)  # 缩放半径上限
    if minRadius < 0:  # 如果半径下限小于0
        minRadius = 0  # 如果半径下限置0
    else:  # 否则
        minRadius = round(minRadius)  # 缩放半径下限

    circles = []  # 初始化储存结果的数组

    edgeCoords = np.argwhere(edges)/dp  # 获取边缘坐标并缩放

    for centreCoord in centreCoords:  # 对所有圆心坐标
        radiusList = [0]*(int(maxRadius-minRadius)+1)  # 初始化LUT
        for edgeCoord in edgeCoords:  # 对所有边缘坐标
            radius = np.linalg.norm(centreCoord-edgeCoord, ord=2)  # 计算边缘点到圆心距离
            if minRadius <= radius <= maxRadius:  # 若距离在阈值内
                radiusList[round(radius-minRadius)] += 1  # 投票
        circles.append(
            (centreCoord[1], centreCoord[0], radiusList.index(max(radiusList))+minRadius))  # 保存圆心坐标及对应的最有可能的半径

    circles = np.array([circles])*dp  # 缩放回原图尺寸

    if debug:  # 调试模式下
        return circles, (edges, parameterSpace)  # 返回值包括中间信息

    return circles  # return result


def main() -> None:
    # Read lanes image
    lanes = cv2.imread("./src/lanes.png")
    lanes = BGR2GRAY(lanes)  # grayscale

    # Read wheel image
    wheel = cv2.imread("./src/wheel.png")
    wheel = BGR2GRAY(wheel)  # grayscale

    ksize = 3  # 窗口大小为3x3
    sigma = 1  # 经测试，该σ值效果较好

    lanes = GaussianBlur(lanes, ksize, sigma,
                         borderType=BorderTypes.BORDER_REPLICATE)  # 图像降噪

    wheel = GaussianBlur(wheel, ksize, sigma,
                         borderType=BorderTypes.BORDER_REPLICATE)  # 图像降噪

    lowerThreshold = 100  # 经测试，该低阈值效果较好
    upperThreshold = 200  # 经测试，该高阈值效果较好

    binaryEdge, debugInfo = Canny(
        lanes, lowerThreshold, upperThreshold, debug=True)  # 进行Canny边缘检测并获取中间结果

    # 获取中间结果
    gradx, grady, magnitude, direction, suppressedMag, strongEdge, weakEdge, preservedEdge = debugInfo

    # 原始图像的梯度幅值图
    cv2.imwrite("./dst/magnitudeOriginal_lane.png", convertScaleAbs(magnitude))
    # 非极大值抑制后的梯度幅值图
    cv2.imwrite("./dst/nonmaximumSuppressed_lane.png",
                convertScaleAbs(suppressedMag))
    # 双阈值处理和搜索连接后的梯度幅值图
    cv2.imwrite("./dst/doubleThresholdAndHysteresis_lane.png",
                convertScaleAbs(preservedEdge))
    # 梯度二值化图
    cv2.imwrite("./dst/binaryEdge_lane.png", convertScaleAbs(binaryEdge))

    wheelEdge = Canny(wheel, lowerThreshold, upperThreshold)  # Canny边缘检测
    # Canny边缘检测的二值化图
    cv2.imwrite("./dst/binaryEdge_wheel.png", convertScaleAbs(wheelEdge))

    # Inverse ratio of the accumulator resolution to the image resolution.
    dp = 1
    # Minimum distance between the centers of the detected circles.
    minDist = 15
    # The higher threshold of the two passed to the Canny edge detector (the lower one is twice smaller).
    upperThreshold = 80
    # The accumulator threshold for the circle centers at the detection stage.
    accumulatorThreshold = 60
    # Minimum circle radius.
    minRadius = 0
    # Maximum circle radius. If <= 0, uses the maximum image dimension.
    maxRadius = 20

    circles, (edges, parameterSpace) = HoughCircles(wheel, HoughModes.HOUGH_GRADIENT, dp=dp, minDist=minDist,
                                                    param1=upperThreshold, param2=accumulatorThreshold,
                                                    minRadius=minRadius, maxRadius=maxRadius, debug=True)  # 霍夫圆检测
    circles = np.around(circles[0]).astype(int)  # 提取圆坐标及半径

    # 梯度二值化图
    cv2.imwrite("./dst/binaryEdge_wheel.png", convertScaleAbs(edges))
    # 将参数空间缩放为原图大小
    parameterSpace = cv2.resize(convertScaleAbs(
        parameterSpace), (wheel.shape[1], wheel.shape[0]))
    # 霍夫圆快速检测得到的参数空间图
    cv2.imwrite("./dst/parameterSpace_wheel.png",
                convertScaleAbs(parameterSpace))

    wheel = cv2.imread("./src/wheel.png")  # 重新读原图
    for circle in circles:  # 对检测到的每个圆
        cv2.circle(wheel, (circle[0], circle[1]),
                   circle[2], (0, 0, 255), 2)  # 在原图上用红色表示
    # 最后输出车轮的检测图
    cv2.imwrite("./dst/detectedCircles_wheel.png", wheel)


if __name__ == '__main__':
    main()
